{% load static %}

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assign Bus & Manage Conductors</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/dash.css' %}">
</head>
<body>

  <!-- Header -->
  <header>
    <h1>Bus – Route Assignment & Conductor Management</h1>
  </header>

<div class="container mt-5">

  <!-- ================= Bus Assignment Table ================= -->
  <h3 class="text-center">Bus – Route Assignment</h3>
  <div class="d-flex justify-content-center">
    <table class="table table-dark table-striped table-bordered align-middle" style="width: 900px;">
      <thead>
        <tr>
          <th>#</th>
          <th>Bus</th>
          <th>Route</th>
          <th>Status</th>
          <th>
            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#assignModal">+</button>
          </th>
        </tr>
      </thead>
      <tbody>
        {% if assigned %}
          {% for i in assigned %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ i.BusId.name }} - {{ i.BusId.Number }}</td>
            <td>{{ i.RouteId.source }} - {{ i.RouteId.destination }}</td>
            {% if i.status == "Pending" %}
            <td style="color: orange;"><b>{{ i.status }}</b></td>
            {% elif i.status == "Accepted" %}
            <td style="color: green;"><b>{{ i.status }}</b></td>
            {% elif i.status == "Rejected" %}
            <td style="color: red;"><b>{{ i.status }}</b></td>
            {% else %}
            <td>Send Complaint To Admin</td>
            {% endif %}
            <td>
              <button class="btn btn-sm btn-warning editBtn"
                      data-bs-toggle="modal"
                      data-bs-target="#editModal"
                      data-id="{{ i.id }}"
                      data-busid="{{ i.BusId.id }}"
                      data-routeid="{{ i.RouteId.id }}">
                Edit
              </button>
              <button class="btn btn-sm btn-danger" onclick="window.location='/assignbusroute/delete/{{i.id}}/'">Delete</button>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="5" class="text-center">No Assigned Buses</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>


  <!-- ================= Conductor Management Table ================= -->
  <h3 class="text-center mt-5">Conductor Management</h3>
  <div class="d-flex justify-content-center">
    <table class="table table-dark table-striped table-bordered align-middle" style="width: 1000px;">
      <thead>
        <tr>
          <th>#</th>
          <th>Bus</th>
          <th>Name</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Actions 
            <button class="btn btn-outline-primary btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#addConductorModal">+</button>
          </th>
        </tr>
      </thead>
      <tbody>
        {% if conductors %}
          {% for c in conductors %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ c.BusId.name }} - {{ c.BusId.Number }}</td>
            <td>{{ c.name }}</td>
            <td>{{ c.phoneno }}</td>
            <td>{{ c.Email }}</td>
            <td>
              <button class="btn btn-sm btn-info viewConBtn"
                      data-bs-toggle="modal"
                      data-bs-target="#viewConductorModal"
                      data-name="{{ c.name }}"
                      data-phone="{{ c.phoneno }}"
                      data-email="{{ c.Email }}"
                      data-address="{{ c.Address }}"
                      data-idproof="{{ c.Idproof.url }}">
                View
              </button>
              <button class="btn btn-sm btn-warning editConBtn"
                      data-bs-toggle="modal"
                      data-bs-target="#editConductorModal"
                      data-id="{{ c.id }}"
                      data-busid="{{ c.BusId.id }}"
                      data-name="{{ c.name }}"
                      data-phone="{{ c.phoneno }}"
                      data-email="{{ c.Email }}"
                      data-address="{{ c.Address }}">
                Edit
              </button>
              <button class="btn btn-sm btn-danger" onclick="window.location='/conductor/delete/{{c.id}}/'">Delete</button>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="6" class="text-center">No Conductors Assigned</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

</div>


<!-- ================== MODALS ================== -->

<!-- Add Conductor Modal -->
<div class="modal fade" id="addConductorModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light rounded-3">
      <div class="modal-header">
        <h5 class="modal-title">Add Conductor</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form method="post" action="/conductor/add/" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="form-group mb-2">
            <label>Bus</label>
            <select name="BusId" class="form-select" required>
              <option value="">-- Choose Bus --</option>
              {% for i in bus %}
              <option value="{{i.id}}" style="color:black;">{{ i.name }} - {{ i.Number }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group mb-2">
            <label>Name</label>
            <input type="text" name="name" class="form-control" required style="color:black;">
          </div>
          <div class="form-group mb-2">
            <label>Phone</label>
            <input type="number" name="phoneno" class="form-control" required style="color:black;">
          </div>
          <div class="form-group mb-2">
            <label>Email</label>
            <input type="email" name="Email" class="form-control" style="color:black;">
          </div>
          <div class="form-group mb-2">
            <label>Address</label>
            <textarea name="Address" class="form-control" style="color:black;"></textarea>
          </div>
          <div class="form-group mb-3">
            <label>ID Proof</label>
            <input type="file" name="Idproof" class="form-control" style="color:black;">
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Add Conductor</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>


<!-- Edit Conductor Modal -->
<div class="modal fade" id="editConductorModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light rounded-3">
      <div class="modal-header">
        <h5 class="modal-title">Edit Conductor</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form method="post" id="editConductorForm" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="form-group mb-2">
            <label>Bus</label>
            <select id="editBusId" name="BusId" class="form-select"></select>
          </div>
          <div class="form-group mb-2">
            <label>Name</label>
            <input type="text" id="editName" name="name" class="form-control" style="color:black;">
          </div>
          <div class="form-group mb-2">
            <label>Phone</label>
            <input type="number" id="editPhone" name="phoneno" class="form-control" style="color:black;">
          </div>
          <div class="form-group mb-2">
            <label>Email</label>
            <input type="email" id="editEmail" name="Email" class="form-control" style="color:black;">
          </div>
          <div class="form-group mb-2">
            <label>Address</label>
            <textarea id="editAddress" name="Address" class="form-control" style="color:black;"></textarea>
          </div>
          <div class="form-group mb-3">
            <label>Replace ID Proof</label>
            <input type="file" name="Idproof" class="form-control" style="color:black;">
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-warning">Update Conductor</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>


<!-- View Conductor Modal -->
<div class="modal fade" id="viewConductorModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light rounded-3">
      <div class="modal-header">
        <h5 class="modal-title">Conductor Details</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Name:</strong> <span id="viewName"></span></p>
        <p><strong>Phone:</strong> <span id="viewPhone"></span></p>
        <p><strong>Email:</strong> <span id="viewEmail"></span></p>
        <p><strong>Address:</strong> <span id="viewAddress"></span></p>
        <p><strong>ID Proof:</strong> <a id="viewIdProof" target="_blank">View File</a></p>
      </div>
    </div>
  </div>
</div>


<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Populate Edit Conductor Modal
  const editConBtns = document.querySelectorAll('.editConBtn');
  const editConForm = document.getElementById('editConductorForm');
  const editBusId = document.getElementById('editBusId');
  const editName = document.getElementById('editName');
  const editPhone = document.getElementById('editPhone');
  const editEmail = document.getElementById('editEmail');
  const editAddress = document.getElementById('editAddress');

  editConBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      editConForm.action = `/conductor/edit/${id}/`;
      editBusId.value = btn.dataset.busid;
      editName.value = btn.dataset.name;
      editPhone.value = btn.dataset.phone;
      editEmail.value = btn.dataset.email;
      editAddress.value = btn.dataset.address;
    });
  });

  // Populate View Conductor Modal
  const viewConBtns = document.querySelectorAll('.viewConBtn');
  const viewName = document.getElementById('viewName');
  const viewPhone = document.getElementById('viewPhone');
  const viewEmail = document.getElementById('viewEmail');
  const viewAddress = document.getElementById('viewAddress');
  const viewIdProof = document.getElementById('viewIdProof');

  viewConBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      viewName.textContent = btn.dataset.name;
      viewPhone.textContent = btn.dataset.phone;
      viewEmail.textContent = btn.dataset.email;
      viewAddress.textContent = btn.dataset.address;
      viewIdProof.href = btn.dataset.idproof;
    });
  });
</script>
</body>
</html>
